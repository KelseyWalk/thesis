---
title: "IAPI_1"
author: "Kelsey Walker"
date: "1/15/2022"
output: html_document
---

```{r include = FALSE}
library("dplyr")
library("tidyverse")
library("readxl")
library("lubridate")
library("ggplot2")
library("fitdistrplus")
library("fmsb") #for radar/spider chart
library("data.table")
library("hrbrthemes")
library("viridis")
```

# Read in data
```{r}
data <- readRDS("~kelseywalker/Desktop/EPIC HOMES/R_thesis/omni_1hour.rds") 

living <-   filter(data, location == 'living') %>%
  dplyr::select(id_home, datetime, co2, voc, pm25, temp, humid) %>%
  na.omit(living)

kitchen <- filter(data, location == 'kitchen') %>%
  dplyr::select(id_home, datetime, co2, voc, pm25, temp, humid) %>%
  na.omit(kitchen)

# Average living and kitchen for each parameter, keep only days with at least 22hrs of data
data2 <- bind_rows(living,kitchen) %>%
  group_by(id_home, datetime) %>%
  summarise_each(funs(mean)) %>%
  mutate( date = date(datetime)) %>%
  group_by(id_home, date) %>%
  filter(n() >= 22 ) %>% #Only include days where at least 22hrs of monitoring existed
  filter(!c(id_home == "029"| id_home == "030" | id_home == "031"| id_home == "032" | id_home == "033")) # homes 001 - 028

```

#create daily averages
```{r}
  data_daily <- data2 %>%
  summarise(pm25 = mean(pm25), co2 = mean(co2), voc = mean(voc), temp = mean(temp), humid = mean(humid))

#write_rds(data_daily, "OMNI_daily_processed.rds")
```

  
# Distributions
Results:
Min, Max, Mean, 5th & 95th percentile
```{r}
# dmc data from 3/14/2022
# quanitles, ecdf linear interpolation 3/15
# PM 2.5
dmc_pm25 <- 15 #micrograms/m3 
min_pm25 <- 0.968 #5th quantile
max_pm25 <- 33.461 #95th quantile

# CO2
dmc_co2 <- 1000 #ppm
min_co2 <- 461.169 #5th
max_co2 <- 1073.226#95th

# VOC
dmc_voc <- 200 #micrograms/m3 = ppb
min_voc <- 107.442 #5th
max_voc <- 1205.729 #95th


```

#### Create observed location and weight term
```{r}
inputs <- data_daily %>%
  rename(pm25_L = pm25) %>%
  mutate(pm25_W = pm25_L, .after=pm25_L) %>%
  rename(voc_L = voc) %>%
  mutate(voc_W = voc_L, .after=voc_L) %>%
  rename(co2_L = co2) %>%
  mutate(co2_W = co2_L, .after=co2_L) %>%
  dplyr::select(!c(temp, humid))
```

## Meet Conditions for IAPI equation Cobs>Cmin, Cobs<Cmas, Cobs<Cdmc #DISCUSS dmc
```{r}
inputs <- inputs %>%
# PM25
  #1. If Obs < Min
  mutate(pm25_L = replace (pm25_L, pm25_L < min_pm25, min_pm25)) %>%
  mutate(pm25_W = replace (pm25_W, pm25_W < min_pm25, min_pm25)) %>%
  # 2. If Obs > Max
  mutate(pm25_L = replace(pm25_L, pm25_L > max_pm25, max_pm25)) %>%
  mutate(pm25_W = replace(pm25_W, pm25_W > max_pm25, dmc_pm25)) %>%
  # 3. If Obs > dmc #? What does "but" mean? Why not say "and"?
  mutate(pm25_L = replace (pm25_L, pm25_L > dmc_pm25, dmc_pm25)) %>%
  mutate(pm25_W = replace (pm25_W, pm25_W > dmc_pm25, dmc_pm25)) %>%

# VOC
  #1. If Obs < Min
  mutate(voc_L = replace (voc_L, voc_L < min_voc, min_voc)) %>%
  mutate(voc_W = replace (voc_W, voc_W < min_voc, min_voc)) %>%
  # 2. If Obs > Max
  mutate(voc_L = replace(voc_L, voc_L > max_voc, max_voc)) %>%
  mutate(voc_W = replace(voc_W, voc_W > max_voc, dmc_voc)) %>%
  # 3. If Obs > dmc 
  mutate(voc_L = replace (voc_L, voc_L > dmc_voc, dmc_voc)) %>%
  mutate(voc_W = replace (voc_W, voc_W > dmc_voc, dmc_voc)) %>%

# CO2
  #1. If Obs < Min
  mutate(co2_L = replace (co2_L, co2_L < min_co2, min_co2)) %>%
  mutate(co2_W = replace (co2_W, co2_W < min_co2, min_co2)) %>%
  # 2. If Obs > Max
  mutate(co2_L = replace(co2_L, co2_L > max_co2, max_co2)) %>%
  mutate(co2_W  = replace(co2_W, co2_W > max_co2, dmc_co2)) %>%
  # 3. If Obs > dmc #? What does "but" mean? Why not say "and"?
  mutate(co2_L = replace (co2_L, co2_L > dmc_co2, dmc_co2)) %>%
  mutate(co2_W  = replace (co2_W, co2_W > dmc_co2, dmc_co2))

```



# Level-1
```{r}
index <- inputs %>%
  #PM2.5
  mutate(pm25_level1 = 10 * (1 - (max_pm25 - pm25_L) / (max_pm25 - min_pm25) * (dmc_pm25 - pm25_W)/dmc_pm25)) %>%
  #VOC
  mutate(voc_level1 = 10 * (1 - (max_voc - voc_L) / (max_voc - min_voc) * (dmc_voc - voc_W)/dmc_voc)) %>%
  #CO2
  mutate(co2_level1 = 10 * (1 - (max_co2 - co2_L) / (max_co2 - min_co2) * (dmc_co2 - co2_W)/dmc_co2))
```

# Level-2 & Level-3
```{r}
index <- mutate(index, gas_level2 = (co2_level1 + voc_level1) / 2) %>%
  mutate(particles_level2 = pm25_level1) %>%
  mutate(IAPI = (gas_level2 + particles_level2) / 2)
```

# Percentage
```{r}
results <- dplyr::select(index, id_home, date, pm25_level1, voc_level1, co2_level1, gas_level2, particles_level2, IAPI) %>%
  mutate(gas_percent = round(gas_level2/(gas_level2 + particles_level2) *100)) %>%
  mutate(particles_percent = 100-gas_percent) %>%
  mutate(pm25_percent = particles_percent) %>%
  mutate(voc_percent = round(voc_level1/(voc_level1 + co2_level1)*gas_percent)) %>%
  mutate(co2_percent = round(co2_level1/(voc_level1 + co2_level1)*gas_percent))
```

```{r}
IAPI <- dplyr::select(results, id_home,date, IAPI)
#write_rds(IAPI, "IAPI_1.rds")
#write_csv(results, "IAPI_1.csv")
```

#Facet
```{r}
ggplot(data = IAPI, aes(date, IAPI)) + 
  geom_point(size = 0.3) +
  facet_wrap(~id_home) +
  scale_x_date(date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 45, hjust =1))

```

# Time Series for Each Home
```{r}
home3 <- filter(index, id_home == "002" | id_home == "006" | id_home == "013")

ggplot(data = home3, aes(x = date)) + 
   geom_point(shape = 3, size = 1, aes(date, pm25_level1, color = "red")) + 
  geom_point(shape = 4, size = 1, aes(date, co2_level1, color = "purple")) + 
  geom_point(shape = 1, size = 1, aes(date, voc_level1, color = "darkgreen")) + 
   geom_point(aes(date, IAPI, color = "black"),shape = 16, size = 1.5) +
    theme(legend.title = element_blank(), legend.position = "bottom") +
  ggtitle("Indoor Air Pollution Index")  + 
  facet_grid(rows = vars(id_home)) + 
  scale_x_date(date_labels = "%b %Y") +
  scale_color_identity(
    breaks = c("black", "red", "purple", "darkgreen"),
    labels = c("IDI", "PM2.5", "CO2", "TVOC"),
    guide = "legend")  +
  labs(y = "IAPI")


home3 <- filter(results, id_home == "003")

ggplot(data = home3, aes(x = date)) + 
  geom_line(aes(y = IAPI, colour = "IAPI")) +
  geom_point(aes(y = pm25_level1, colour = "pm25")) + 
  geom_point(aes(y = co2_level1, colour = "co2")) + 
  geom_point(aes(y = voc_level1, colour = "voc")) + 
  ggtitle("IAPI: Home 003") +
  labs(colour = "Indoor Air Pollution") # Title Legend

#ggsave(filename = "IAPI_001_point_2.jpg", plot = p1)
```

# Radar/Spider Plot
#```{r}

max_min <- data.frame(
  pm25_level1 = c(10,0), voc_level1 = c(10,0), co2_level1 = c(10,0), gas_level2 = c(10,0), particles_level2 = c(10,0)
)
rownames(max_min)<- c("Max", "Min")

data_radar <- results[1,] %>%
  dplyr::select(pm25_level1, voc_level1, co2_level1, gas_level2, particles_level2) #%>%
  rbind(max_min, data_radar)


radarchart(data_radar)
#```

# Box Plot for homes
```{r}
sample_size = results %>%
  group_by(id_home) %>%
  summarize(num = n())

box_plot <- merge(results, sample_size, by = "id_home") %>%
  mutate(myaxis = paste0(id_home, "\n", num ))


ggplot(box_plot, aes(x=myaxis , y = IAPI)) +
  geom_boxplot()+
  ggtitle("IAPI Boxplots") + 
  labs(x = "House ID", "\n", "sample size") +
  theme(axis.text.x = element_text(angle = 0, hjust =1))
  
 

```
